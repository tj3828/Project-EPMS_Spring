package com.hb.chat;

import java.util.ArrayList;

import org.apache.ibatis.annotations.Insert;
import org.apache.ibatis.annotations.Param;
import org.apache.ibatis.annotations.Select;

import config.Mapper;

@Mapper
public interface IChatDAOMapper {
	
	@Insert("insert into chatting values("
			+ "chatting_seq.nextval, "
			+ "#{fromNick}, "
			+ "#{toNick},"
			+ "to_date(#{writeDate},'YY/MM/DD HH24:MI'),"
			+ "#{content},"
			+ "#{readCheck}"
			+ ")")
	void insertMessage(ChatVO dto);
	
	@Select("select num, fromNick, toNick, to_char(writeDate,'YY/MM/DD HH24:MI') as writeDate, content, readCheck from ( "
			+ 	"select * from chatting "
			+ 		"where (fromNick = #{id} and toNick = #{opponent}) or (fromNick = #{opponent} and toNick = #{id}) "
			+ ") order by num asc")
	ArrayList<ChatVO> selectMessageList(@Param("id") String id, @Param("opponent") String opponent);
	
	@Select("select num, fromNick, toNick, to_char(writeDate,'YY/MM/DD HH24:MI') as writeDate, content, readCheck from ( "
			+ 	"select chatting.* from ( "
			+ 		"select * from ( "
			+ 			"select fromNick, toNick, MAX(num) as num from chatting "
			+ 				"group by fromNick, toNick "
			+ 				"having fromNick = #{id} or toNick = #{id} "
			+ 		") a inner join ( "
			+ 			"select fromNick, toNick, MAX(num) as num from chatting "
			+ 				"group by fromNick, toNick "
			+ 				"having fromNick = #{id} or toNick = #{id} "
			+ 		") b on (a.fromNick = #{id} and a.toNick = b.fromNick) or (a.toNick = #{id} and a.FromNick = b.toNick)"
			+ 		" where a.num = (select max(num) from b as d where (d.num = a.num) "
			+ 	") c inner join chatting on c.num = chatting.num "
			+ ") order by writeDate desc ")
	ArrayList<ChatVO> selectChatsList(@Param("id") String id);
}
