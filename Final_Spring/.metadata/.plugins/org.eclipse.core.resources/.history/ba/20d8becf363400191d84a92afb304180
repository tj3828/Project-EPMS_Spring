package com.hb.chat;

import java.util.Properties;

import javax.inject.Singleton;
import javax.servlet.http.HttpSession;
import javax.websocket.HandshakeResponse;
import javax.websocket.server.HandshakeRequest;
import javax.websocket.server.ServerEndpointConfig;

import org.apache.ibatis.session.SqlSession;
import org.apache.ibatis.transaction.jdbc.JdbcTransactionFactory;
import org.mybatis.guice.MyBatisModule;
import org.mybatis.guice.datasource.builtin.PooledDataSourceProvider;
import org.mybatis.guice.session.SqlSessionManagerProvider;
import org.springframework.aop.interceptor.ExposeBeanNameAdvisors;

import com.google.inject.AbstractModule;
import com.google.inject.Guice;
import com.google.inject.Injector;
import com.google.inject.Scopes;
import com.google.inject.assistedinject.FactoryModuleBuilder;

import config.Mapper;


public class HttpSessionConfigurator extends ServerEndpointConfig.Configurator {

	private static Injector injector = Guice.createInjector(new AbstractModule() {
		
		@Override
		protected void configure() {
			
			install(new MyBatisModule() {

				@Override
				protected void initialize() {
					bindDataSourceProviderType(PooledDataSourceProvider.class);
					bindTransactionFactoryType(JdbcTransactionFactory.class);
					addMapperClass(IChatDAOMapper.class);
				}
				
			});
			
			bind(SqlSession.class).toProvider(SqlSessionManagerProvider.class).in(Scopes.SINGLETON);
			
			bind(IChatService.class).annotatedWith(Mapper.class).to(ChatServiceImpl.class);
			
		}
		
		
	});
	
    @Override
	public <T> T getEndpointInstance(Class<T> endpointClass) throws InstantiationException {
    	 return injector.getInstance(endpointClass);
	}

	@Override
    public void modifyHandshake(ServerEndpointConfig sec, HandshakeRequest request, HandshakeResponse response) {
        System.out.println("modifyHandshake() Current thread " + Thread.currentThread().getName());
        sec.getUserProperties().put("http", request.getHttpSession()); 
        System.out.println("modifyHandshake() User " + "http" + " with http session ID " + ((HttpSession) request.getHttpSession()).getId());
    }
	
	public Properties createProperties(String schema) {
        final Properties myBatisProperties = new Properties();
         
        myBatisProperties.setProperty("mybatis.environment.id", schema);
        myBatisProperties.setProperty("JDBC.driver", "oracle.jdbc.driver.OracleDriver");
        myBatisProperties.setProperty("JDBC.url", "jdbc:oracle:thin:@127.0.0.1:1521:XE");
        myBatisProperties.setProperty("JDBC.username", "system");
        myBatisProperties.setProperty("JDBC.password", "oracle");
        myBatisProperties.setProperty("JDBC.autoCommit", "false");
         
        return myBatisProperties;
    }

}